#!/usr/bin/env node

/**
 * Setup Languages Script
 * Creates stub files for all supported languages (if not exist),
 * then generates index.ts from all available translation files.
 * Usage: node setup-languages.js [locales-dir]
 */

import fs from 'fs';
import path from 'path';
import { LANGUAGE_MAP, getLangDisplayName } from './utils/translation-config.js';

export function setupLanguages(targetDir) {
  const localesDir = path.resolve(process.cwd(), targetDir);

  if (!fs.existsSync(localesDir)) {
    console.error(`âŒ Locales directory not found: ${localesDir}`);
    return false;
  }

  // Create stub files for all supported languages that don't exist yet
  let created = 0;
  for (const langCode of Object.keys(LANGUAGE_MAP)) {
    // Skip English variants â€” en-US is the base, others (en-AU, en-GB) are redundant
    if (langCode.startsWith('en-') && langCode !== 'en-US') continue;

    const filePath = path.join(localesDir, `${langCode}.ts`);
    if (!fs.existsSync(filePath)) {
      const langName = getLangDisplayName(langCode);
      fs.writeFileSync(
        filePath,
        `/**\n * ${langName} Translations\n * Auto-synced from en-US.ts\n */\n\nexport default {};\n`,
      );
      console.log(`   âœ… Created ${langCode}.ts (${langName})`);
      created++;
    }
  }

  if (created > 0) {
    console.log(`\nðŸ“¦ Created ${created} new language stubs.\n`);
  }

  // Generate index.ts from all language files
  const files = fs.readdirSync(localesDir)
    .filter(f => f.match(/^[a-z]{2}-[A-Z]{2}\.ts$/))
    .sort();

  const imports = [];
  const exports = [];

  files.forEach(file => {
    const code = file.replace('.ts', '');
    const varName = code.replace(/-([a-z0-9])/g, (g) => g[1].toUpperCase()).replace('-', '');
    imports.push(`import ${varName} from "./${code}";`);
    exports.push(`  "${code}": ${varName},`);
  });

  const content = `/**
 * Localization Index
 * Exports all available translation files
 * Auto-generated by scripts/setup-languages.js
 */

${imports.join('\n')}

export const translations = {
${exports.join('\n')}
};

export type TranslationKey = keyof typeof translations;

export default translations;
`;

  fs.writeFileSync(path.join(localesDir, 'index.ts'), content);
  console.log(`âœ… Generated index.ts with ${files.length} languages`);
  return true;
}

if (import.meta.url === `file://${process.argv[1]}`) {
  const targetDir = process.argv[2] || 'src/domains/localization/infrastructure/locales';
  console.log('ðŸš€ Setting up language files...\n');
  setupLanguages(targetDir);
}
